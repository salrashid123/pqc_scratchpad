#### Cryptographic Message Syntax (CMS) for KEM draft-ietf-lamps-cms-kyber-13

Just an interpretation/implementation in go of

* [Use of ML-KEM in the Cryptographic Message Syntax (CMS)](https://datatracker.ietf.org/doc/draft-ietf-lamps-cms-kyber/)

>> please note this is *draft* and just a **best guess** on what the implementation would look like; do not use this in prod

> also, critically, stadnard go does **NOT** support parsing KEM public keys types.  The code below uses a modified `crypto/x509.go` described in [../issue_cert/x509.diff](../issue_cert/x509.diff)

the code here just does something very simple: it just uses a static KEM public/private key, a static aes key and nonce to generate a cms.


The reason this uses a static keypair was just to try and create the same 'test vector' described at the bottom of `draft-ietf-lamps-cms-kyber`.  You can see that by running `baseline/main.go`.  If you wanted to generate a new aes keypair, run `main.go` (theyr'e similar except to comply/mimic the "test vector", used the same nonce and 'random' static aes key in baseline)

Ofcourse in real life, you'd use your own keypair and random aes key...

but if you run this app, you'll end up with `c.cms` file which when you use openssl to decode, you'll get


```bash
$ openssl cms -cmsout -print -noout -inform PEM -in c.cms

CMS_ContentInfo: 
  contentType: id-smime-ct-authEnvelopedData (1.2.840.113549.1.9.16.1.23)
  d.authEnvelopedData: 
    version: 0
    originatorInfo: <ABSENT>
    recipientInfos:
      d.ori: 
        oriType: undefined (1.2.840.113549.1.9.16.13.3)
        oriValue: SEQUENCE:
    0:d=0  hl=4 l=1203 cons: SEQUENCE          
    4:d=1  hl=2 l=   1 prim:  INTEGER           :00
    7:d=1  hl=2 l=  20 prim:  OCTET STRING      [HEX DUMP]:CF51CC7C3EB2B06D6DA02A0FAB7F7C86AF840A78
   29:d=1  hl=2 l=  11 cons:  cont [ 0 ]        
   31:d=2  hl=2 l=   9 prim:   OBJECT            :ML-KEM-768
   42:d=1  hl=4 l=1088 prim:  OCTET STRING      [HEX DUMP]:03041EC64CFC5396A0A1F95CBB579C130E30A3FFBCC9BEF541A5398907A930C9573DE9477BA6A93B35201E3B48A63AA56E8279AEAD27F7B89D42960FAE99A79121C3BB4DBC4E35807A930FD296AC7828E2FD388296CBB0FB754225D0384029E613C2B6E644B3F74A77EDDE95549DD21321E89EE125F20FA4B68E6065F0017851493DCCC2E03B7BCBA9825CFFC8D480E3F9E796D2EEA17F46FBA5A941FD35EF8D45B463398268A2B875159F51779C5EA8FD6220201DF7927A0020C50B1B1568E1D5A28C8175732DF553950EFC1BE436F5D1BE17B2F7210D118240E4853C76A789D08D0FB9639E77F18C38BA798D8ABC41A4204B3D48B6893D3D953040C400582948911137036102DB9558E2B4EF9583038DD57FDE0FC482CA09421AD3F401173261420869FF40D1049DEB98D92AE997C698441469BCCA83523FD7077AF0822F781355138F6EF6EC3AD55146B28F979036611DCFEFA1B10D944EF13740035677A5EE9CD54D676DEDD3AA75835A4742BFF87F43BF4B967B6ECECB5E409701B74FFFB7D045425E3525BE035F529EF43D0EA3E0919C9DE166D4419948AFC2FAA0DFEF95584CEA6E9A101D4A9FBA33C775A3CD7B3B39B4AA715E7AF2D5557EB62324460E7B4BAAD63428CCA3964C816B20E83084B106BA8BD2B8F7984FED86312999B0F1D1FB177907B3A231B7CD32176A9AADE14F00A2C23BA3D55E9BD3D8F5277D8E90B7885508EE1AA5DE4CAC79EC27ED170C7902B1FF5177A3B060F5DF453EE198DDAF576E884BBF8664FCE972E4F1351F7972ADB4BD96ADF5565971E9D98A4AD813876D12F7360F16066A7B7F69E96ACD65E64D44001DD1FC8B17E2C7520F1877E9B3603272EF53A5BAF46D8F550226B4CCDE25CE1B622BBFD8A62EDC3691107F1ED5927B78ED848756A06EBFC074DCA5528A5A67A9141C361AABC4EC9304F0066C96FD6CFE2D5F9EFEAED0308E6E87421B81628053B2395F05347714B219EEDE50B34CEF07112D5FDB31E104302648F5FC205CF2172FEC9BE68B4509AFF81527A660CA7E0810E353456F7A64230EB6B016E1FD5CAAD8750B161B95BC18AC331593F9566D9DCD88E2D8C970412382F42C1A140485039F35BD2FDA4F4F41E079C9A7A6E3744D20AF8D5A67D2CB446BB5635A2FAEDFA8C2573874138FE5FAB8B802463C48FB600E31512B0C59AECCB7CB7B2C81B8368729295F27EE9BC85A58F4F383ABA066ED608B334F3C9B47EC8ED5704A4206705006AFD894D55D3BAB3A218AE0033E14559114A9C35BCA13CF18E9EAD0E6ACB2623E850BFF1F4C25AAB18F1A3297D8CDCB23083D22D7EEBDF80CC737405AA389B9DBD4D57AFDE91BDFA99F3E4737EF74F20997DE52B79396BE7034EBA38F1B9798468978A20FCF5D0CB307A99F29D07793D95FC34BCD1CE95ED481BCB80BEE3FCAEC7D0C3C0161818354AD7BDF75A73F344705B41BCE8E871CD3500B6BD9F98EB069AC1F6AFC7218B92799AC1AAF2199323AB7F474D66770DDFAAB5110FDD900E4E9681ED0D74102E6923019
 1134:d=1  hl=2 l=  13 cons:  SEQUENCE          
 1136:d=2  hl=2 l=  11 prim:   OBJECT            :1.2.840.113549.1.9.16.3.28
 1149:d=1  hl=2 l=   1 prim:  INTEGER           :10
 1152:d=1  hl=2 l=  11 cons:  SEQUENCE          
 1154:d=2  hl=2 l=   9 prim:   OBJECT            :id-aes128-wrap
 1165:d=1  hl=2 l=  40 prim:  OCTET STRING      [HEX DUMP]:7543C33AF7804BDE5BCF48F0CBE65175A596C7F2D8D2A7A45626ADD4B97F5FFE4CA5C93C567AB932
    authEncryptedContentInfo: 
      contentType: pkcs7-data (1.2.840.113549.1.7.1)
      contentEncryptionAlgorithm: 
        algorithm: aes-128-gcm (2.16.840.1.101.3.4.1.6)
        parameter: SEQUENCE:
    0:d=0  hl=2 l=  17 cons: SEQUENCE          
    2:d=1  hl=2 l=  12 prim:  OCTET STRING      [HEX DUMP]:C2838A9C652172DEA20F4BE3
   16:d=1  hl=2 l=   1 prim:  INTEGER           :10
      encryptedContent: 
        0000 - 04 0d 82 4e fb e6 b6 90-3b 6b 80 82 3f e4 af   ...N....;k..?..
    authAttrs:
      <ABSENT>
    mac: 
      0000 - a6 56 b6 10 dd 8a 42 fb-09 05 d8 6c 9b bf 18 5f   .V....B....l..._
    unauthAttrs:
      <ABSENT>

```

you can compare that to the `baseline.cms` file described in the draft/proposal.   

Note that you get pretty much the same cms file (with the exception that i encded the subketidentifier into the PEM for completness sake)


```bash
$ openssl cms -cmsout -print -noout -inform PEM -in baseline.cms 

CMS_ContentInfo: 
  contentType: id-smime-ct-authEnvelopedData (1.2.840.113549.1.9.16.1.23)
  d.authEnvelopedData: 
    version: 0
    originatorInfo: <ABSENT>
    recipientInfos:
      d.ori: 
        oriType: undefined (1.2.840.113549.1.9.16.13.3)
        oriValue: SEQUENCE:
    0:d=0  hl=4 l= 867 cons: SEQUENCE          
    4:d=1  hl=2 l=   1 prim:  INTEGER           :00
    7:d=1  hl=2 l=  20 prim:  cont [ 0 ]        
   29:d=1  hl=2 l=  11 cons:  SEQUENCE          
   31:d=2  hl=2 l=   9 prim:   OBJECT            :ML-KEM-512
   42:d=1  hl=4 l= 768 prim:  OCTET STRING      [HEX DUMP]:3EA40FC6CA090E2C8AF76E2727AB38E0652D9515986FE186827FE84E596E421B85FD459CC78997372C9DE31D191B39C1D5A3EB6DDB56AADEDE765CC390FDBBC2F88CB175681D4201B81CCDFCB24FEF13AF2F5A1ABCF8D8AF384F02A010A6E919F1987A5E9B1C0E2D3F07F58A9FA539CE86CC149910A1692C0CA4CE0ECE4EEED2E6699CB976332452DE4A2EB5CA61F7B081330C34798EF712A24E59C33CEA1F1F9E6D4FBF3743A38467430011336F62D870792B866BEFCD1D1B365BED1952673D3A5B0C20B386B4EFD1CF63FD376BD47CCC46AC4DD8EC66B047C4C95ACFF1CFD028A419B002FDA1B617CBA61D2E91CFE8FFFBCB8FFD4D5F6AD8B158C219E36DC51405DC0C0B234979AC658E72BDDF1B6773B96B2AE3E4D07BE86048040C0167436FA839E7529B00CC9AB55A2F25DB63CC9F557594E691C11E553D4A3EBC760F5F19E5FE144838B4C7D1591DA9B5D467494FD9CAC52CC5504060399DBDB72298EB9A4C017B00786FDC7D9D7AA57ADBB8B61C34DE1E288B2AB728171DCE143CD16953F984C1AED559E56BAA0CE658D32CCE42F4407504CD7A579AD0EF9B77135EAA39B6F93A3A2E5997807F06361C83F4E67F8E3F9CF68316011514F5D85A181CEAD714CD4940E4EBAC01D66528DA32F89CEA0428E8EBCADCF8AA188C9F62E85B1957655B7FE2B8D7973B7A7226B66D93BF7B232F3DCF653C84B4ECF1A9920DB1949AD750B546A5552A20E54909719B8C0C07056FCB7E574AD2A32EC95001DDE84481BE77D039ED5BF74262ECF3981F1B00D3366A9C2E061C47E241A061C6249560D2B8446A480C38C28BA989D9F68ADC4BBAF2A20B47E4923128C72342D597FDA259DE0B83C2056D6B77E799B319324AA50B1D659C2A56029B7453C5F3BA5243D9FA749D917C40D9D101E453BC8B10E42A7C089323C026F783E100B9FA6E7014424DA6FA3792BC957EE8219D016B773F28FEDCC962A485ABAFFEC023281971E29AA689839ECFD2619E92287CD230DB26A2507CC500EB1C7A5293B5FE917AE29BF1AD350124F8A311635214B411DB9F67D3B85BD715018537EA45B41F41B4C66051
  814:d=1  hl=2 l=  13 cons:  SEQUENCE          
  816:d=2  hl=2 l=  11 prim:   OBJECT            :1.2.840.113549.1.9.16.3.28
  829:d=1  hl=2 l=   1 prim:  INTEGER           :10
  832:d=1  hl=2 l=  11 cons:  SEQUENCE          
  834:d=2  hl=2 l=   9 prim:   OBJECT            :id-aes128-wrap
  845:d=1  hl=2 l=  24 prim:  OCTET STRING      [HEX DUMP]:C050E4392F9C14DD0AC2220203F317D701F94F9DD92778F5
    authEncryptedContentInfo: 
      contentType: pkcs7-data (1.2.840.113549.1.7.1)
      contentEncryptionAlgorithm: 
        algorithm: aes-128-gcm (2.16.840.1.101.3.4.1.6)
        parameter: SEQUENCE:
    0:d=0  hl=2 l=  17 cons: SEQUENCE          
    2:d=1  hl=2 l=  12 prim:  OCTET STRING      [HEX DUMP]:5CA57468B81BF03B8DA7186C
   16:d=1  hl=2 l=   1 prim:  INTEGER           :10
      encryptedContent: 
        0000 - 94 c8 68 9a 99 d2 c3 8e-19 2f a6 ba 08         ..h....../...
    authAttrs:
      <ABSENT>
    mac: 
      0000 - 5c f1 78 6c 57 c7 40 2b-54 fc 93 c3 0a 4a 45 33   \.xlW.@+T....JE3
    unauthAttrs:
      <ABSENT>

```


```bash
$ go run main.go 

Creating public x509wrote issued.pem
SubjectKeyId cf51cc7c3eb2b06d6da02a0fab7f7c86af840a78
Issuer and serialNumber 304c310b3009060355040613025553310f300d060355040a0c06476f6f676c6531133011060355040b0c0a456e74657270726973653117301506035504030c0e53696e676c6520526f6f74204341021015f017052db5bdc261640e6997676851
kemcipherText d0c9e70340846b903e452a422d11fd5fb0722992353464c68fc9bd066c06a8964c960fd404f2dbd21d0f348345cfa338fb6f901b2bc65060185188b6388bd47c9c3dec85b8bbeba7c4c1caa3f6d00f3e147432ff10891e0a0e6729ba3f5c907ce2aa21c36885f051d35c5cca2de8b92b236e2742948cb2a36594dd1e78df7a50a2a37b37af6f4cc95c644fc60af613347a8f7e491c3b1ca2c52c0b6898307143db4a6b92019b142aafc3e2fcdfbb94f3273ee0460f0537df00bd8e99389ca74e4adf973d200e0a9db81d6d51f858d2fc2f2f1d8933288bc6b0f9304675a2cd1c462d6d321da0c729fb1d03d3b081f446763d6245a2be3dccc57f410a1394bdece63c1cbca98431db767a6288a15a997c042921965ca522de6d6f61a866132d1646da99aa5f9cbb1e16cc4c3e1895dea0b8ebd23f36da069a0f2d42c8d013253395080b8e986d81496dbd5b9d6c1d15b1c20897bd0ae366eb636290cacc7171eb85723319bfbc9f3f260f36e4f972526ec1c20e851fbeb8ab165a3fb15f49fbc90e1fed017e333ab7cfa8aef4196a3527ef8a69e9c5100a961ea6a0e17dad2156c5f5a1708c3b5e23199bfbd4d1c0717b1816f428ff164a41d41aa2766e486e1cffb5ea75f20f07694e7c2763e817a891a0ea574383c1342cad14413e5c3e16b09eb778a25bdfcda2fccda3a84030942e30683023d2635cb2badf42b69f9fcd21d40265759d69909d11cf6908c0a31744c67bbd893ac09f0f9c5ab1bdb3bead0e5f4be1c8a1081d64b87a25fd898ff62c7762baae7acd762bc0996d238c487c47ef5a46c472e506f551e5e74282e895a49484d30cd6fb798030b4ed040ccf5f0127e2b2acb52e9023d462c80596113aedbc15a634b9725c4009100679fbd48882b350f5a9ff53d37c6dd56164ae753f073d452301bf3de87169a477fa632cd25d741a82ead7020d48704ebeefe5b67e742c801979be9f415bb9ac3f38d80493d95fcf00b2b5890351385c4b34edfff1d2ea883ebbde62cfb06c284d1893f35c36ceb0cd41b5241a7c7577424e06028fd25b68652587a3ba8e433ca88c452613ef4817d24e660e32755c6ae415a661df2bf1965b7bf59a03e0bf3c74ef0462a4e04179870b51385e7f808cc09552864d7c923239433fbdaf72520e5e5537410cf4f5c45cecbc584570ec293e73cfdff1e4c92e56ffc05ef8991de081d4bb3872c2acd306952de73a0c0566ee725c25a715918af73e4ce7b6b5c18ce95fdd5825f96a17ea309de22832ada8a59a1b7bcb4a5b9ff9f90dcad88ddf4bc6a16c15ba53a79b2373ecbe61d56d0f8c7fe6a71a827afa1d95bef55710bbe9aec1ebd85107d02c9c687ddf1d0bad7457f0434809ec5b10f018d696b270da5f5a5dcd8876106cb317c86fc96bb1947e6f9cf5b5302b5b7f975f29abe3e342ca4e0f877af835ea244c3ea1336c42b2c38a90b29b715700dd947264497e187da5c4779184649cfe14881b3d70e9526172f484922ee75a340d2c676fce84ea819af429a9168387
SharedSecret: kemShared (GhXJBcSnBJyAQNuJ2bo7aJX2+oLpSSRi3WHwMiBOAgY=) 
root_key rWG5+kTRNuAeyIoCd5Zg3EPg5BCgdRdpWhnWMGVwqmw= 
spi cf51cc7c3eb2b06d6da02a0fab7f7c86af840a78
CMSORIforKEMOtherInfo 3010300b0609608648016503040105020110
KEK 8d013e0ce043e9a90b0f5551b77cd0bc
actualCiphertext 920ed86499f2325c86791e6a62
ciphertextWithMac 920ed86499f2325c86791e6a62672b7502b948b22c6b627161d89bee29
mac 672b7502b948b22c6b627161d89bee29
tagSize 16
-----BEGIN CMS-----
MIIFNAYLKoZIhvcNAQkQARegggUjMIIFHwIBADGCBMikggTEBgsqhkiG9w0BCRAN
AzCCBLMCAQAEFM9RzHw+srBtbaAqD6t/fIavhAp4oAsGCWCGSAFlAwQEAgSCBEDQ
yecDQIRrkD5FKkItEf1fsHIpkjU0ZMaPyb0GbAaolkyWD9QE8tvSHQ80g0XPozj7
b5AbK8ZQYBhRiLY4i9R8nD3shbi766fEwcqj9tAPPhR0Mv8QiR4KDmcpuj9ckHzi
qiHDaIXwUdNcXMot6LkrI24nQpSMsqNllN0eeN96UKKjezevb0zJXGRPxgr2EzR6
j35JHDscosUsC2iYMHFD20prkgGbFCqvw+L837uU8yc+4EYPBTffAL2OmTicp05K
35c9IA4KnbgdbVH4WNL8Ly8diTMoi8aw+TBGdaLNHEYtbTIdoMcp+x0D07CB9EZ2
PWJFor49zMV/QQoTlL3s5jwcvKmEMdt2emKIoVqZfAQpIZZcpSLebW9hqGYTLRZG
2pmqX5y7HhbMTD4Yld6guOvSPzbaBpoPLULI0BMlM5UIC46YbYFJbb1bnWwdFbHC
CJe9CuNm62NikMrMcXHrhXIzGb+8nz8mDzbk+XJSbsHCDoUfvrirFlo/sV9J+8kO
H+0BfjM6t8+orvQZajUn74pp6cUQCpYepqDhfa0hVsX1oXCMO14jGZv71NHAcXsY
FvQo/xZKQdQaonZuSG4c/7XqdfIPB2lOfCdj6BeokaDqV0ODwTQsrRRBPlw+FrCe
t3iiW9/NovzNo6hAMJQuMGgwI9JjXLK630K2n5/NIdQCZXWdaZCdEc9pCMCjF0TG
e72JOsCfD5xasb2zvq0OX0vhyKEIHWS4eiX9iY/2LHdiuq56zXYrwJltI4xIfEfv
WkbEcuUG9VHl50KC6JWklITTDNb7eYAwtO0EDM9fASfisqy1LpAj1GLIBZYROu28
FaY0uXJcQAkQBnn71IiCs1D1qf9T03xt1WFkrnU/Bz1FIwG/PehxaaR3+mMs0l10
GoLq1wINSHBOvu/ltn50LIAZeb6fQVu5rD842AST2V/PALK1iQNROFxLNO3/8dLq
iD673mLPsGwoTRiT81w2zrDNQbUkGnx1d0JOBgKP0ltoZSWHo7qOQzyojEUmE+9I
F9JOZg4ydVxq5BWmYd8r8ZZbe/WaA+C/PHTvBGKk4EF5hwtROF5/gIzAlVKGTXyS
MjlDP72vclIOXlU3QQz09cRc7LxYRXDsKT5zz9/x5MkuVv/AXviZHeCB1Ls4csKs
0waVLec6DAVm7nJcJacVkYr3PkzntrXBjOlf3Vgl+WoX6jCd4igyrailmht7y0pb
n/n5DcrYjd9LxqFsFbpTp5sjc+y+YdVtD4x/5qcagnr6HZW+9VcQu+muwevYUQfQ
LJxofd8dC610V/BDSAnsWxDwGNaWsnDaX1pdzYh2EGyzF8hvyWuxlH5vnPW1MCtb
f5dfKavj40LKTg+Hevg16iRMPqEzbEKyw4qQsptxVwDdlHJkSX4YfaXEd5GEZJz+
FIgbPXDpUmFy9ISSLudaNA0sZ2/OhOqBmvQpqRaDhzANBgsqhkiG9w0BCRADHAIB
EDALBglghkgBZQMEAQUEKCfVjoa5H6s58WBq9z1ESImt8Rty00rRfNo/f+KeDBC0
yDVOFzBUgs4wPAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBBjARBAx6EpqhMAxss8MI
v/ACARCADwQNkg7YZJnyMlyGeR5qYgQQZyt1ArlIsixrYnFh2JvuKQ==
-----END CMS-----
```


---

TODO:

AAD text is supposed to get encoded into the envelope as authenticated attributes like so:

```golang
	idaaintendedRecipients := asn1.ObjectIdentifier{1, 2, 840, 113549, 1, 9, 16, 2, 33}

	//
	authAttr := Attribute{
		Type: idaaintendedRecipients,
		RawValue: []asn1.RawValue{{
			Class: asn1.ClassUniversal,
			Tag:   asn1.TagOctetString,
			Bytes: aad,
		},
		},
	}

	ed := AuthEnvelopedData{
		Version:        0,
		RecipientInfos: ri,
		AECI:           eci,
		MAC:            mac,
		AauthAttrs:     []Attribute{authAttr},
	}

```

however, while i can encode it into the PEM, i can't figure out how to make openssl parse it, i keep seeing `wrong_tag`:

```bash
$ openssl cms -cmsout -print -noout -inform PEM -in c.cms 
Error reading SMIME Content Info
80ABE529AF7F0000:error:068000A8:asn1 encoding routines:asn1_check_tlen:wrong tag:crypto/asn1/tasn_dec.c:1194:
80ABE529AF7F0000:error:0688010A:asn1 encoding routines:asn1_d2i_ex_primitive:nested asn1 error:crypto/asn1/tasn_dec.c:752:
80ABE529AF7F0000:error:0688010A:asn1 encoding routines:asn1_template_noexp_d2i:nested asn1 error:crypto/asn1/tasn_dec.c:685:Field=mac, Type=CMS_AuthEnvelopedData
80ABE529AF7F0000:error:0688010A:asn1 encoding routines:asn1_template_noexp_d2i:nested asn1 error:crypto/asn1/tasn_dec.c:685:
80ABE529AF7F0000:error:0688010A:asn1 encoding routines:asn1_template_ex_d2i:nested asn1 error:crypto/asn1/tasn_dec.c:537:Field=d.authEnvelopedData, Type=CMS_ContentInfo
```


which after a bit of fiddling found out openssl uses the wrong tag value  [openssl/issues/26101](https://github.com/openssl/openssl/issues/26101)
